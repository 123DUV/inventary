<!DOCTYPE html >
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Inventario</title>
<link rel="icon" href="inv.png" type="image/x-icon">
<!--boostrap-->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<!-- SweetAlert2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- alertify cdn, js-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css" />
<script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>
</head>

<body>
<div class="container">
<div class="row mt-3 justify-content-center align-items-center">
<input id="search" class="form-control d-none mb-2 mt-2 w-75" type="search" placeholder="Escribe para buscar..." />

</div>
<div class="row d-flex justify-content-center align-items-center">
<button class="btn btn-success mt-1 w-50" onclick="showRegister()">Crear registro</button>
<button class="btn btn-primary mt-1 mx-1 w-25" onclick="toggleSearch()"><i
class="bi bi-search"></i></button>

</div>
<div class="row d-none mt-2" id="registers">
<div class="col-12 col-md-12 rounded mt-2 mb-2 pt-2 justify-content-center align-items-center d-flex flex-column" style="box-shadow: rgba(0, 0, 0, 0.25) 0px 54px 55px, rgba(0, 0, 0, 0.12) 0px -12px 30px, rgba(0, 0, 0, 0.12) 0px 4px 6px, rgba(0, 0, 0, 0.17) 0px 12px 13px, rgba(0, 0, 0, 0.09) 0px -3px 5px;">
<input class="form-control mt-2" type="text" name="name" id="name" value placeholder="Nombre producto" />
<input class="form-control mt-1" type="text" name="amount" id="amount" value placeholder="Cantidad" />
<input class="form-control mt-1" type="text" name="price" id="price" value placeholder="Precio c/u" />
<button type="button" id="send" class="btn btn-success mt-3 w-50 mb-2">Agregar</button>

</div>
</div>
<div class="row mt-1">
<div class="table-responsive shadow rounded">
<table class="table table-striped table-hover align-middle text-center">
<thead class="table-dark">
<tr>
<th>ID</th>
<th>Producto</th>
<th>Cantidad</th>
<th>+</th>
<th>-</th>
<th>Precio c/u</th>
<th>Precio total</th>
<th><i class="bi bi-trash"></i></th>
</tr>
</thead>
<tbody id="info">

</tbody>
</table>
<div id="add">

</div>
</div>
</div>

</div>
<!--modal info producto -->
<div>

<!-- Modal de información de producto -->
<div class="modal fade" id="productoModal" tabindex="-1" aria-labelledby="productoModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">

<div class="modal-header">
<h5 class="modal-title" id="productoModalLabel">Información del Producto</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
</div>

<div class="modal-body">
<form id="modalFormEdit">
<div class="mb-3">
  <input type="hidden" id="idModalEdit" name="idModalEdit">
<label for="name" class="form-label">Nombre</label>
<input type="text" class="form-control" id="nameModal" name="nameModal" placeholder="Ej: Zapatos deportivos" disabled>
</div>

<div class="mb-3">
<label for="quantity" class="form-label">Cantidad</label>
<input type="number" name="amountModal" class="form-control" id="amountModal" placeholder="Ej: 10" disabled>
</div>

<div class="mb-3">
<label for="unitPrice" class="form-label">Precio c/u</label>
<input type="number" name="unitPrice"  class="form-control" id="unitPrice" placeholder="Ej: 50.00" disabled>
</div>

<div class="mb-3">
<label for="totalPrice" class="form-label">Precio total</label>
<input type="number" name="totalPriceModal" class="form-control" id="totalPriceModal" placeholder="Ej: 500.00" readonly disabled>
</div>

<div class="mb-3">
<label for="promotion" class="form-label">Promoción</label>
<input type="text" class="form-control" id="promotion" name="promotion" placeholder="Ej: 10% descuento" disabled>
</div>
<div class="mb-3">
<button class="btn btn-success off" type="button" id="editModal"><i class="bi bi-pen"></i></button>
</div>
</form>
</div>

<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
<button type="button" class="btn btn-success" id="saveEditModal">Guardar</button>
</div>
</div>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">
//llenar select de precios
const priceSelect = document.getElementById('price');
for (let i = 1000; i <= 100000; i += 1000) {
const option = document.createElement('option');
option.value = i;
option.textContent = new Intl.NumberFormat('es-CO', {
style: 'currency',
currency: 'COP'
}).format(i);
priceSelect.appendChild(option);
}
//array q almacena los datos
let allData = []
// Cargar datos al iniciar la página
document.addEventListener('DOMContentLoaded', loadData);

const botonSend = document.getElementById('send');

// Obtener datos de la API y mostrarlos en la tabla
function loadData() {
fetch('./api.php?action=list')
.then(response => response.json())
.then(data => {
allData = data; // guardamos los datos originales
renderRows(allData);
})
.catch(error => console.error('Error fetching data:', error));
}


function renderRows(rows) {
if (rows.length === 0) {
document.getElementById('info').innerHTML = '<tr><td colspan="8">No hay datos disponibles</td></tr>';
return;
}

const info = document.getElementById('info');
info.innerHTML = '';
rows.forEach(item => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${fixEncoding(item.id)}</td>
<td onclick="getInfo(${item.id})">${item.name}</td>
<td>${item.amount}</td>
<td><button class="btn btn-success  mx-1 sumAmount" data-id="${item.id}">+</button></td>
<td><button class="btn btn-danger  mx-1 lessAmount" data-id="${item.id}">-</button></td>
<td>${new Intl.NumberFormat('es-CO', {
style: 'currency', currency: 'COP'
}).format(item.price)}</td>
<td>${new Intl.NumberFormat('es-CO', {
style: 'currency', currency: 'COP'
}).format(item.totalPrice)}</td>
<td><button class="btn btn-danger mx-1 deleteRow" data-id="${item.id}"><i class="bi bi-trash"></i></button></td>
`;
info.appendChild(row);
});
document.querySelectorAll('.lessAmount').forEach(btn => {
btn.addEventListener('click', function() {
const id = this.dataset.id; // tomar id del producto
fetch('./api.php?action=less', {
method: 'post',
headers: {
'Content-Type': 'application/x-www-form-urlencoded'
},
body: `id=${id}`
})
.then(response => response.json())
.then(data => {
loadData(); // recargar datos después de actualizar

})
.catch(e => console.error(e));
});
});
//borrar fila
document.querySelectorAll('.deleteRow').forEach(btn => {
btn.addEventListener('click', function() {
const id = this.dataset.id; // tomar id del producto
fetch('./api.php?action=deleteRow', {
method: 'post',
headers: {
'Content-Type': 'application/x-www-form-urlencoded'
},
body: `id=${id}`
})
.then(response => response.json())
.then(data => {
loadData(); // recargar datos después de actualizar

})
.catch(e => console.error(e));
});
});
document.querySelectorAll('.sumAmount').forEach(btn => {
btn.addEventListener('click', function() {
const id = this.dataset.id; // tomar id del producto
fetch('./api.php?action=sumAmount', {
method: 'post',
headers: {
'Content-Type': 'application/x-www-form-urlencoded'
},
body: `id=${id}`
})
.then(response => response.json())
.then(data => {
loadData(); // recargar datos después de actualizar

})
.catch(e => console.error(e));
});
});
}
// Evento click del boton guardar

botonSend.addEventListener('click', function() {
const name = document.getElementById('name').value.toLowerCase().trim();
const amount = document.getElementById('amount').value
const price = document.getElementById('price').value



if (name == undefined || name == null || name == "") {
Swal.fire({
icon: 'info',
title: 'Campo vacio',
text: 'Completa todos los campos'
})
return false;
} else if (amount == undefined || amount == null || amount == "") {
Swal.fire({
icon: 'info',
title: 'Campo vacio',
text: 'Completa todos los campos'
})
return false;
} else if (price == undefined || price == null || price == "") {
Swal.fire({
icon: 'info',
title: 'Campo vacio',
text: 'Completa todos los campos'
})
return false;
} else {
fetch('./api.php?action=save', {
method: 'post',
headers: {
'Content-Type': 'application/x-www-form-urlencoded'
},
body: `name=${name}&amount=${amount}&price=${price}&totalPrice=${amount*price}`
})
.then(response => {
if (!response.ok) {
if (response.status === 409) {
Swal.fire({
icon: 'error',
title: 'Error',
text: 'El producto ya existe'
})
} else {
throw new Error('Error en la solicitud');
}
} else if (response.status === 200) {
alertify.set('notifier', 'position', 'top-center')
alertify.success("Agregado")
}
response.json()
}).then(data => {
loadData();
document.getElementById("name").value = "";
document.getElementById("amount").value = "";
document.getElementById("price").value = "";
// recargar datos después de guardar

}).catch(e => {
alertify.set('notifier', 'position', 'top-center')
alertify.error("Error agregando")
console.error(e)
})
}
})

function getInfo(id) {

fetch('./api.php?action=getInfoById', {
method: 'post',
headers: {
'Content-Type': 'application/x-www-form-urlencoded'
},
body: "id="+ encodeURIComponent(id)
})
.then(response => {
if (!response.ok) {
if (response.status === 409) {
Swal.fire({
icon: 'error',
title: 'Error',
text: 'Error trayendo información del producto'
})
} else {
throw new Error('Error en la solicitud');
}
} else if (response.status === 200) {
console.log("correcto obteniendo info para editar modal")
}
return response.json()
})
.then(data => {
const producto = data[0];
document.getElementById("idModalEdit").value = id;
document.getElementById("nameModal").value = producto.name;
document.getElementById("amountModal").value = producto.amount;
document.getElementById("unitPrice").value = producto.price;
document.getElementById("totalPriceModal").value = producto.price * producto.amount;
const modal = new
bootstrap.Modal(document.getElementById("productoModal"));
modal.show();


})
.catch (error => {
console.error("Error al obtener los datos del producto:", error);
Swal.fire({
icon: "error",
title: "error",
text: `error trayendo los datos del producto ${error}`
})
})
}

function showRegister() {
document.getElementById('registers').classList.toggle('d-none');
}

function toggleSearch() {
const search = document.getElementById('search');
search.classList.toggle('d-none');
search.value = '';
renderRows(allData); // restablecer tabla al mostrar buscador
}
document.getElementById('search').addEventListener('input', e => {
const q = e.target.value.toLowerCase();
const filtered = allData.filter(item =>
item.name.toLowerCase().includes(q) ||
String(item.amount).includes(q) ||
String(item.price).includes(q) ||
String(item.id).includes(q)
);
renderRows(filtered);
});
function fixEncoding(str) {
return decodeURIComponent(escape(str));
}

document.getElementById("saveEditModal").addEventListener("click", function() {
const formulario = document.getElementById("modalFormEdit");
const form = new FormData(formulario);

fetch('./api.php?action=editInfo', {
method: 'post',
body: form
})
.then(response => {
if (!response.ok) {
if (response.status === 409) {
Swal.fire({
icon: 'error',
title: 'Error',
text: 'Error trayendo información del producto'
})
} else {
throw new Error('Error en la solicitud');
}
} else if (response.status === 200) {
Swal.fire({
icon: 'success',
title: 'Correcto',
text: 'Edición correcta'
}).then((result)=>{
  if(result.isConfirmed){
      const modal = new
bootstrap.Modal(document.getElementById("productoModal"));
modal.show();
window.location.reload()
  }
})
}
return response.json();
})
.then(data=>{
  
  console.log("info al guardar modal editado: ",data);

})
.catch(error=>{
  console.error(error);
})
})

//activar o desactivar inputs modal edit
const btnEdit = document.getElementById("editModal");
btnEdit.addEventListener("click", function() {
if (btnEdit.classList.contains("off")) {
btnEdit.classList.remove("off");

document.getElementById("nameModal").removeAttribute("disabled");
document.getElementById("amountModal").removeAttribute("disabled");
document.getElementById("unitPrice").removeAttribute("disabled");

document.getElementById("promotion").removeAttribute("disabled")
} else {
btnEdit.classList.add("off");
document.getElementById("nameModal").setAttribute("disabled", true);
document.getElementById("amountModal").setAttribute("disabled", true);
document.getElementById("unitPrice").setAttribute("disabled", true);

document.getElementById("promotion").setAttribute("disabled", true)
}


})
const inputAmount = document.getElementById("amountModal");
const inputPrice = document.getElementById("unitPrice");
const totalPrice = document.getElementById("totalPriceModal");

function calcularTotal(){
  const cantidad = parseFloat(inputAmount.value) ||0;
  
  const unitPrice = parseFloat(inputPrice.value) ||0;
  let sum = cantidad * unitPrice;
  totalPrice.value = sum;
}
inputAmount.addEventListener("input", function(){
  calcularTotal()
})
inputPrice.addEventListener("input", function(){
  calcularTotal()
})
</script>
</body>

</html>